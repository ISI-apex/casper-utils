#!/bin/bash

set -e
set -x

#if [[ "$#" -lt 4 ]]
#then
#	echo "ERROR: invalid arguments" 1>&2
#	echo "USAGE: $0 prefix nodes tasks_per_node" 1>&2
#	exit 1
#fi

usage() {
	echo "USAGE: $0 prefix_path args_to_mpirun... command program args..." 1>&2
	echo "      'command' is a keyword (also effectively a no-op in bash)" 1>&2
}

if [[ "$#" -lt 1 ]]
then
	echo "ERROR: invalid arguments" 1>&2
	exit 1
fi


prefix=$1
shift 1
#nodes=$2
#tasks_per_node=$3
#shift 3

mpirun_args=()
while [[ "$#" -gt 0 && "$1" != "command" ]]
do
	mpirun_args+=($1)
	shift
done
if [[ "$#" = 0 || "$1" != "command" ]]
then
	echo "ERROR: invalid arguments: no command"
	usage
	exit 1
fi
shift # command

mpirun_args+=(
	-v
	--mca ras_base_verbose 100
	--mca plm_alps_debug 100
	--mca plm_base_framework.framework_output 100
)

#extra_args+=(-n ${nodes} --map-by ppr:${tasks_per_node}:node)

# this is the tmpirun from casper-utils/bin/theta
exec tmpirun ${mpirun_args[@]} ${prefix}/startprefix -c "bash -x -c \"$(echo $@)\""
#exec tmpirun ${mpirun_args[@]} ${prefix}/bin/bash -x -c "$(echo $@)"
#exec tmpirun ${mpirun_args[@]} env > ${prefix}/job.env2
